<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PSX Portfolio Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0e17;--surface:#111827;--surface2:#1a2333;--border:#1f2d42;
    --accent:#00d4aa;--accent2:#f59e0b;--red:#ef4444;--green:#10b981;
    --text:#e2e8f0;--muted:#64748b;
    --mono:'IBM Plex Mono',monospace;--sans:'Syne',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;
    background-image:radial-gradient(ellipse at 20% 0%,#00d4aa08 0%,transparent 50%),
                     radial-gradient(ellipse at 80% 100%,#f59e0b06 0%,transparent 50%);}
  .header{padding:1.25rem 2rem;border-bottom:1px solid var(--border);display:flex;align-items:center;
    justify-content:space-between;position:sticky;top:0;background:rgba(10,14,23,0.95);
    backdrop-filter:blur(12px);z-index:100;}
  .logo{display:flex;align-items:center;gap:.75rem;}
  .logo-mark{width:34px;height:34px;background:var(--accent);border-radius:8px;display:flex;
    align-items:center;justify-content:center;font-weight:800;font-size:13px;color:var(--bg);}
  .logo-text{font-size:1.1rem;font-weight:700;letter-spacing:-.02em;}
  .logo-sub{font-family:var(--mono);font-size:.6rem;color:var(--muted);}
  .main{max-width:1200px;margin:0 auto;padding:1.5rem 2rem;}
  .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:1rem;margin-bottom:2rem;}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.1rem 1.3rem;position:relative;overflow:hidden;}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);opacity:.3;}
  .card.hl::before{opacity:1;}
  .card-label{font-family:var(--mono);font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.4rem;}
  .card-value{font-size:1.5rem;font-weight:800;letter-spacing:-.03em;}
  .card-sub{font-family:var(--mono);font-size:.68rem;color:var(--muted);margin-top:.2rem;}
  .btn{font-family:var(--sans);font-weight:600;font-size:.78rem;padding:.45rem .9rem;border-radius:8px;border:none;cursor:pointer;transition:all .15s;letter-spacing:.02em;}
  .btn-primary{background:var(--accent);color:var(--bg);}
  .btn-primary:hover{background:#00f0c0;}
  .btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
  .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
  .btn-danger{background:transparent;color:var(--red);border:1px solid transparent;padding:.28rem .55rem;font-size:.72rem;}
  .btn-danger:hover{border-color:var(--red);}
  .btn-warn{background:transparent;color:var(--accent2);border:1px solid transparent;padding:.28rem .55rem;font-size:.72rem;}
  .btn-warn:hover{border-color:var(--accent2);}
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;}
  .section-title{font-size:.95rem;font-weight:700;}
  .section-title span{color:var(--accent);}
  .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:1.5rem;}
  table{width:100%;border-collapse:collapse;}
  thead tr{background:var(--surface2);}
  th{font-family:var(--mono);font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);padding:.8rem .9rem;text-align:left;white-space:nowrap;}
  th.r{text-align:right;}
  td{padding:.85rem .9rem;font-family:var(--mono);font-size:.8rem;border-top:1px solid var(--border);vertical-align:middle;}
  td.r{text-align:right;}
  tr:hover td{background:rgba(255,255,255,.015);}
  .ticker{font-weight:600;color:var(--accent);font-size:.88rem;font-family:var(--sans);}
  .green{color:var(--green);} .red{color:var(--red);} .muted{color:var(--muted);}
  .strike{text-decoration:line-through;color:var(--muted);font-size:.7rem;}
  .adj-badge{display:inline-block;background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.25);
    color:var(--accent);font-size:.6rem;padding:.08rem .35rem;border-radius:4px;margin-left:.3rem;vertical-align:middle;}
  .empty-state{text-align:center;padding:2.5rem;color:var(--muted);font-family:var(--mono);font-size:.78rem;}
  .empty-state .big{font-size:2rem;margin-bottom:.4rem;opacity:.3;}
  .tabs{display:flex;gap:.4rem;margin-bottom:1.25rem;}
  .tab{font-family:var(--sans);font-size:.78rem;font-weight:600;padding:.45rem .9rem;border-radius:8px;
    border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all .15s;}
  .tab.active{background:var(--surface2);border-color:var(--accent);color:var(--accent);}
  .pane{display:none;} .pane.active{display:block;}
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);
    z-index:200;align-items:center;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.75rem;
    width:440px;max-width:95vw;animation:slideUp .2s ease;}
  @keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
  .modal-title{font-size:1rem;font-weight:700;margin-bottom:1.25rem;}
  .modal-title span{color:var(--accent);}
  .form-group{margin-bottom:.9rem;}
  label{display:block;font-family:var(--mono);font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.35rem;}
  input,select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;
    padding:.6rem .85rem;color:var(--text);font-family:var(--mono);font-size:.82rem;outline:none;transition:border-color .15s;}
  input:focus,select:focus{border-color:var(--accent);}
  input::placeholder{color:var(--muted);}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;}
  .modal-actions{display:flex;gap:.6rem;margin-top:1.25rem;justify-content:flex-end;}
  .hint{font-family:var(--mono);font-size:.62rem;color:var(--muted);margin-top:.25rem;line-height:1.5;}
  .status-line{font-family:var(--mono);font-size:.72rem;min-height:1.1rem;margin-bottom:.5rem;}
  .sync-badge{font-family:var(--mono);font-size:.65rem;padding:.2rem .5rem;border-radius:6px;margin-left:.5rem;}
  .sync-ok{color:var(--green);}
  .sync-err{color:var(--red);}
  .sync-ing{color:var(--muted);}
  /* ‚îÄ‚îÄ MOBILE CARDS ‚îÄ‚îÄ */
  @media(max-width:768px){
    .main{padding:.75rem;} .header{padding:.75rem 1rem;}
    .logo-sub{display:none;}
    .summary{grid-template-columns:1fr 1fr;}
    /* Hide desktop table, show mobile cards */
    .desktop-table{display:none !important;}
    .mobile-cards{display:block !important;}
    .m-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;
      padding:1rem;margin-bottom:.75rem;}
    .m-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;}
    .m-card-ticker{font-family:var(--sans);font-weight:700;font-size:1rem;color:var(--accent);}
    .m-card-actions{display:flex;gap:.4rem;}
    .m-card-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem .75rem;}
    .m-card-field{}
    .m-card-label{font-family:var(--mono);font-size:.58rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:.15rem;}
    .m-card-value{font-family:var(--mono);font-size:.82rem;}
    .m-card-notes{font-family:var(--mono);font-size:.68rem;color:var(--muted);margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border);}
  }
  /* Hide mobile cards on desktop */
  .mobile-cards{display:none;}
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <div class="logo-mark">P</div>
    <div>
      <div class="logo-text">PSX Tracker</div>
      <div class="logo-sub">DIVIDEND-ADJUSTED PORTFOLIO</div>
    </div>
  </div>
  <div style="display:flex;gap:.5rem;align-items:center;">
    <span id="sync-status" class="sync-badge"></span>
    <button class="btn btn-ghost" onclick="openSettings()">‚òÅ Sync Setup</button>
    <button class="btn btn-ghost" onclick="exportData()">Export</button>
    <button class="btn btn-primary" onclick="openAddStock()">+ Add Stock</button>
  </div>
</div>

<div class="main">
  <div class="summary">
    <div class="card hl">
      <div class="card-label">Total Invested</div>
      <div class="card-value" style="color:var(--accent)" id="s-invested">0</div>
      <div class="card-sub">PKR</div>
    </div>
    <div class="card">
      <div class="card-label">Current Value</div>
      <div class="card-value" id="s-value">0</div>
      <div class="card-sub">PKR</div>
    </div>
    <div class="card">
      <div class="card-label">Total Dividends</div>
      <div class="card-value" style="color:var(--accent2)" id="s-div">0</div>
      <div class="card-sub">PKR received</div>
    </div>
    <div class="card">
      <div class="card-label">True P&L (incl. dividends)</div>
      <div class="card-value" id="s-pnl">0</div>
      <div class="card-sub" id="s-pnl-pct">0%</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('holdings',this)">Holdings</button>
    <button class="tab" onclick="switchTab('dividends',this)">Dividend Log</button>
  </div>

  <div class="pane active" id="pane-holdings">
    <div class="section-header">
      <div class="section-title">Your <span>Holdings</span></div>
      <button class="btn btn-ghost" onclick="openUpdatePrices()">Update Prices</button>
    </div>
    <div class="table-wrap desktop-table">
      <table>
        <thead>
          <tr>
            <th>Stock</th><th class="r">Shares</th><th class="r">Avg Buy</th>
            <th class="r">Adj. Cost Basis</th><th class="r">Div/Share</th>
            <th class="r">Current Price</th><th class="r">P&L</th><th class="r">True P&L</th><th></th>
          </tr>
        </thead>
        <tbody id="holdings-body"></tbody>
      </table>
    </div>
    <div id="holdings-empty" class="empty-state"><div class="big">üìà</div>Add your first stock to get started</div>
    <div class="mobile-cards" id="holdings-cards"></div>
    <p style="font-family:var(--mono);font-size:.62rem;color:var(--muted)">True P&L = price gain + all dividends received</p>
  </div>

  <div class="pane" id="pane-dividends">
    <div class="section-header">
      <div class="section-title">Dividend <span>History</span></div>
    </div>
    <div class="table-wrap desktop-table">
      <table>
        <thead>
          <tr><th>Stock</th><th>Date</th><th class="r">Per Share (PKR)</th><th class="r">Shares</th><th class="r">Total Received</th><th>Notes</th><th></th></tr>
        </thead>
        <tbody id="div-body"></tbody>
      </table>
    </div>
    <div id="div-empty" class="empty-state"><div class="big">üí∞</div>No dividends recorded yet</div>
    <div class="mobile-cards" id="div-cards"></div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="modal-confirm">
  <div class="modal" style="width:320px">
    <div class="modal-title" id="confirm-title">Are you sure?</div>
    <p id="confirm-msg" style="color:var(--muted);font-family:var(--mono);font-size:.78rem;margin-bottom:1.25rem;line-height:1.6"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-confirm')">Cancel</button>
      <button class="btn btn-primary" id="confirm-btn" style="background:var(--red)">Delete</button>
    </div>
  </div>
</div>

<!-- Add/Edit Stock Modal -->
<div class="modal-overlay" id="modal-stock">
  <div class="modal">
    <div class="modal-title" id="modal-stock-title">Add <span>Stock</span></div>
    <div class="form-group">
      <label>Ticker Symbol</label>
      <input type="text" id="f-ticker" placeholder="e.g. ENGRO" style="text-transform:uppercase">
    </div>
    <div class="form-row">
      <div class="form-group"><label>Number of Shares</label><input type="number" id="f-shares" placeholder="500"></div>
      <div class="form-group"><label>Avg Buy Price (PKR)</label><input type="number" id="f-avgbuy" placeholder="407.00" step="0.01"></div>
    </div>
    <div class="form-group">
      <label>Current Price (PKR) <span style="color:var(--muted);font-size:.6rem">optional</span></label>
      <input type="number" id="f-current" placeholder="Leave blank" step="0.01">
    </div>
    <div class="form-group"><label>Notes</label><input type="text" id="f-notes" placeholder="Optional notes"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-stock')">Cancel</button>
      <button class="btn btn-primary" onclick="saveStock()">Save Stock</button>
    </div>
  </div>
</div>

<!-- Add Dividend Modal -->
<div class="modal-overlay" id="modal-div">
  <div class="modal">
    <div class="modal-title">Add <span>Dividend</span></div>
    <div class="form-group"><label>Stock</label><select id="fd-ticker"></select></div>
    <div class="form-row">
      <div class="form-group"><label>Dividend Per Share (PKR)</label><input type="number" id="fd-pershare" placeholder="7.00" step="0.01"></div>
      <div class="form-group"><label>Date</label><input type="date" id="fd-date"></div>
    </div>
    <div class="form-group">
      <label>Shares Held at That Time</label>
      <input type="number" id="fd-shares">
      <div class="hint">Leave as-is if same as current holding</div>
    </div>
    <div class="form-group"><label>Notes</label><input type="text" id="fd-notes" placeholder="e.g. Interim dividend FY24"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-div')">Cancel</button>
      <button class="btn btn-primary" onclick="saveDividend()">Save Dividend</button>
    </div>
  </div>
</div>

<!-- Edit Dividend Modal -->
<div class="modal-overlay" id="modal-div-edit">
  <div class="modal">
    <div class="modal-title">Edit <span>Dividend</span></div>
    <input type="hidden" id="fde-id">
    <div class="form-group"><label>Stock</label><input type="text" id="fde-ticker" disabled style="opacity:.5"></div>
    <div class="form-row">
      <div class="form-group"><label>Per Share (PKR)</label><input type="number" id="fde-pershare" step="0.01"></div>
      <div class="form-group"><label>Date</label><input type="date" id="fde-date"></div>
    </div>
    <div class="form-group"><label>Shares Held</label><input type="number" id="fde-shares"></div>
    <div class="form-group"><label>Notes</label><input type="text" id="fde-notes"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-div-edit')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditDividend()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Manual Price Update Modal -->
<div class="modal-overlay" id="modal-prices">
  <div class="modal">
    <div class="modal-title">Update <span>Prices</span></div>
    <div id="price-fields"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-prices')">Cancel</button>
      <button class="btn btn-primary" onclick="savePrices()">Save Prices</button>
    </div>
  </div>
</div>

<!-- GitHub Sync Settings Modal -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal">
    <div class="modal-title">‚òÅ <span>GitHub Sync</span> Setup</div>
    <p style="font-family:var(--mono);font-size:.72rem;color:var(--muted);margin-bottom:1.1rem;line-height:1.6">
      Your portfolio data will be saved as <code style="color:var(--accent2);background:var(--surface2);padding:.1rem .3rem;border-radius:4px">portfolio-data.json</code> in your GitHub repo ‚Äî accessible from any device.
    </p>
    <div class="form-group">
      <label>GitHub Username</label>
      <input type="text" id="cfg-user" placeholder="jahanzebios">
    </div>
    <div class="form-group">
      <label>Repository Name</label>
      <input type="text" id="cfg-repo" placeholder="psx-tracker">
    </div>
    <div class="form-group">
      <label>Personal Access Token</label>
      <input type="password" id="cfg-token" placeholder="github_pat_...">
      <div class="hint">Stored only in your browser. Never sent anywhere except GitHub's own API.</div>
    </div>
    <div class="status-line" id="cfg-status"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-settings')">Cancel</button>
      <button class="btn btn-ghost" onclick="testGitHubConnection()">Test</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save & Sync</button>
    </div>
  </div>
</div>

<script>
// ===================== DATA =====================
let ghConfig  = JSON.parse(localStorage.getItem('psx_gh_config')  || '{}');
let portfolio = JSON.parse(localStorage.getItem('psx_portfolio')  || '[]');
let dividends = JSON.parse(localStorage.getItem('psx_dividends')  || '[]');
let editingId = null;
let dataSHA   = null; // GitHub file SHA needed for updates

function saveLocal() {
  localStorage.setItem('psx_gh_config',  JSON.stringify(ghConfig));
  localStorage.setItem('psx_portfolio',  JSON.stringify(portfolio));
  localStorage.setItem('psx_dividends',  JSON.stringify(dividends));
}
function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2,5); }

// ===================== GITHUB SYNC =====================
function ghFileUrl() {
  return `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/portfolio-data.json`;
}

function setSyncStatus(msg, type) {
  const el = document.getElementById('sync-status');
  el.textContent = msg;
  el.className = 'sync-badge sync-'+type;
}

async function loadFromGitHub() {
  if (!ghConfig.token || !ghConfig.user || !ghConfig.repo) return;
  setSyncStatus('loading...', 'ing');
  try {
    const res = await fetch(ghFileUrl(), {
      headers: {
        'Authorization': 'token ' + ghConfig.token,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    if (res.status === 404) {
      setSyncStatus('first sync...', 'ing');
      await saveToGitHub();
      return;
    }
    if (!res.ok) {
      const err = await res.json();
      throw new Error('HTTP '+res.status+': '+(err.message||JSON.stringify(err)));
    }
    const file = await res.json();
    dataSHA = file.sha;
    const data = JSON.parse(atob(file.content.replace(/\n/g,'')));
    portfolio = data.portfolio || [];
    dividends = data.dividends || [];
    saveLocal();
    render();
    setSyncStatus('synced', 'ok');
  } catch(e) {
    setSyncStatus(e.message, 'err');
  }
}

async function saveToGitHub() {
  if (!ghConfig.token || !ghConfig.user || !ghConfig.repo) return;
  setSyncStatus('saving...', 'ing');
  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify({ portfolio, dividends }, null, 2))));
    const body = JSON.stringify({
      message: 'Update portfolio ' + new Date().toISOString().slice(0,10),
      content,
      ...(dataSHA ? { sha: dataSHA } : {})
    });
    const res = await fetch(ghFileUrl(), {
      method: 'PUT',
      headers: {
        'Authorization': 'token ' + ghConfig.token,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error('HTTP '+res.status+': '+(err.message||JSON.stringify(err)));
    }
    const data = await res.json();
    dataSHA = data.content.sha;
    setSyncStatus('saved', 'ok');
  } catch(e) {
    setSyncStatus(e.message, 'err');
  }
}


// Save locally + sync to GitHub
async function save() {
  saveLocal();
  await saveToGitHub();
}

// ===================== SETTINGS =====================
function openSettings() {
  document.getElementById('cfg-user').value  = ghConfig.user  || '';
  document.getElementById('cfg-repo').value  = ghConfig.repo  || '';
  document.getElementById('cfg-token').value = ghConfig.token || '';
  document.getElementById('cfg-status').textContent = '';
  document.getElementById('modal-settings').classList.add('open');
}

async function saveSettings() {
  ghConfig.user  = document.getElementById('cfg-user').value.trim();
  ghConfig.repo  = document.getElementById('cfg-repo').value.trim();
  ghConfig.token = document.getElementById('cfg-token').value.trim();
  saveLocal();
  closeModal('modal-settings');
  dataSHA = null;
  await loadFromGitHub();
}

async function testGitHubConnection() {
  const statusEl = document.getElementById('cfg-status');
  const user  = document.getElementById('cfg-user').value.trim();
  const repo  = document.getElementById('cfg-repo').value.trim();
  const token = document.getElementById('cfg-token').value.trim();
  if (!user||!repo||!token) { statusEl.style.color='var(--red)'; statusEl.textContent='‚ö† Fill in all fields first.'; return; }
  statusEl.style.color='var(--muted)'; statusEl.textContent='Testing...';
  try {
    const res = await fetch(`https://api.github.com/repos/${user}/${repo}`, {
      headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message||'Failed');
    statusEl.style.color='var(--green)';
    statusEl.textContent=`‚úì Connected to ${data.full_name}`;
  } catch(e) {
    statusEl.style.color='var(--red)';
    statusEl.textContent='‚úó '+e.message;
  }
}

// ===================== COMPUTED =====================
function getDivPerShare(ticker) {
  return dividends.filter(d=>d.ticker===ticker).reduce((s,d)=>s+parseFloat(d.perShare),0);
}
function getAdjCost(stock) {
  return Math.max(0, parseFloat(stock.avgBuy) - getDivPerShare(stock.ticker));
}
function getTotalDivReceived(ticker) {
  return dividends.filter(d=>d.ticker===ticker).reduce((s,d)=>s+(parseFloat(d.perShare)*parseFloat(d.shares)),0);
}

// ===================== RENDER =====================
function render() { renderSummary(); renderHoldings(); renderDividends(); }
function fmt(n,d=2){ return parseFloat(n).toLocaleString('en-PK',{minimumFractionDigits:d,maximumFractionDigits:d}); }

function renderSummary() {
  let inv=0, val=0, divRec=0;
  portfolio.forEach(s=>{
    inv += s.shares * s.avgBuy;
    val += s.shares * (s.currentPrice || s.avgBuy);
    divRec += getTotalDivReceived(s.ticker);
  });
  const pnl = (val-inv)+divRec;
  const pct = inv>0?(pnl/inv*100):0;
  document.getElementById('s-invested').textContent = fmt(inv,0);
  document.getElementById('s-value').textContent    = fmt(val,0);
  document.getElementById('s-div').textContent      = fmt(divRec,0);
  const el = document.getElementById('s-pnl');
  el.textContent = (pnl>=0?'+':'')+fmt(pnl,0);
  el.className = 'card-value '+(pnl>=0?'green':'red');
  document.getElementById('s-pnl-pct').textContent = (pct>=0?'+':'')+fmt(pct)+'%';
}

function renderHoldings() {
  const tbody = document.getElementById('holdings-body');
  const cards = document.getElementById('holdings-cards');
  const empty = document.getElementById('holdings-empty');
  tbody.innerHTML=''; cards.innerHTML='';
  if(!portfolio.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  portfolio.forEach(s=>{
    const adj    = getAdjCost(s);
    const divPS  = getDivPerShare(s.ticker);
    const hasDiv = divPS>0;
    const cp     = s.currentPrice?parseFloat(s.currentPrice):null;
    const sh     = parseFloat(s.shares);
    const ab     = parseFloat(s.avgBuy);
    const totDiv = getTotalDivReceived(s.ticker);
    const pnl    = cp?(cp-ab)*sh:null;
    const pnlPct = cp?((cp-ab)/ab*100):null;
    const truePnl= cp?((cp-ab)*sh+totDiv):totDiv;
    const truePct= (truePnl/(ab*sh))*100;
    const pnlHtml = cp
      ? `<span class="${pnl>=0?'green':'red'}">${pnl>=0?'+':''}${fmt(pnl,0)} (${pnlPct>=0?'+':''}${fmt(pnlPct)}%)</span>`
      : `<span class="muted">‚Äî</span>`;
    const truePnlHtml = `<span class="${truePnl>=0?'green':'red'}">${truePnl>=0?'+':''}${fmt(truePnl,0)} (${truePct>=0?'+':''}${fmt(truePct)}%)</span>`;
    const adjHtml = hasDiv
      ? `<span class="green">${fmt(adj)}</span><span class="adj-badge">ADJ</span>`
      : `<span>${fmt(ab)}</span>`;

    // Desktop row
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="ticker">${s.ticker}</span>${s.notes?`<br><span class="muted" style="font-size:.66rem">${s.notes}</span>`:''}</td>
      <td class="r">${fmt(sh,0)}</td>
      <td class="r">${fmt(ab)}</td>
      <td class="r">${hasDiv?`<span class="green">${fmt(adj)}</span><span class="adj-badge">ADJ</span><br><span class="strike">${fmt(ab)}</span>`:fmt(ab)}</td>
      <td class="r">${hasDiv?`<span style="color:var(--accent2)">${fmt(divPS)}</span>`:'<span class="muted">‚Äî</span>'}</td>
      <td class="r">${cp?fmt(cp):'<span class="muted">‚Äî</span>'}</td>
      <td class="r">${cp?`<span class="${pnl>=0?'green':'red'}">${pnl>=0?'+':''}${fmt(pnl,0)}<br><small>${pnlPct>=0?'+':''}${fmt(pnlPct)}%</small></span>`:'<span class="muted">‚Äî</span>'}</td>
      <td class="r">${truePnlHtml}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-warn" onclick="openAddDiv('${s.ticker}')">+Div</button>
        <button class="btn btn-ghost" style="padding:.28rem .55rem;font-size:.72rem" onclick="openEditStock('${s.id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteStock('${s.id}')">‚úï</button>
      </td>`;
    tbody.appendChild(tr);

    // Mobile card
    const card = document.createElement('div');
    card.className = 'm-card';
    card.innerHTML = `
      <div class="m-card-header">
        <div>
          <span class="m-card-ticker">${s.ticker}</span>
          ${hasDiv?`<span class="adj-badge">ADJ</span>`:''}
          ${s.notes?`<div style="font-family:var(--mono);font-size:.65rem;color:var(--muted);margin-top:.2rem">${s.notes}</div>`:''}
        </div>
        <div class="m-card-actions">
          <button class="btn btn-warn" onclick="openAddDiv('${s.ticker}')">+Div</button>
          <button class="btn btn-ghost" style="padding:.28rem .55rem;font-size:.72rem" onclick="openEditStock('${s.id}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteStock('${s.id}')">‚úï</button>
        </div>
      </div>
      <div class="m-card-grid">
        <div class="m-card-field"><div class="m-card-label">Shares</div><div class="m-card-value">${fmt(sh,0)}</div></div>
        <div class="m-card-field"><div class="m-card-label">Avg Buy</div><div class="m-card-value">${fmt(ab)}</div></div>
        <div class="m-card-field"><div class="m-card-label">Adj. Cost</div><div class="m-card-value">${adjHtml}</div></div>
        <div class="m-card-field"><div class="m-card-label">Current Price</div><div class="m-card-value">${cp?fmt(cp):'<span class="muted">‚Äî</span>'}</div></div>
        <div class="m-card-field"><div class="m-card-label">P&L</div><div class="m-card-value">${pnlHtml}</div></div>
        <div class="m-card-field"><div class="m-card-label">True P&L</div><div class="m-card-value">${truePnlHtml}</div></div>
        ${hasDiv?`<div class="m-card-field"><div class="m-card-label">Div/Share</div><div class="m-card-value" style="color:var(--accent2)">${fmt(divPS)}</div></div>`:''}
      </div>`;
    cards.appendChild(card);
  });
}

function renderDividends() {
  const tbody=document.getElementById('div-body');
  const cards=document.getElementById('div-cards');
  const empty=document.getElementById('div-empty');
  tbody.innerHTML=''; if(cards) cards.innerHTML='';
  if(!dividends.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  [...dividends].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(d=>{
    const total=parseFloat(d.perShare)*parseFloat(d.shares);
    // Desktop row
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="ticker">${d.ticker}</span></td>
      <td>${d.date||'‚Äî'}</td>
      <td class="r" style="color:var(--accent2)">${fmt(d.perShare)}</td>
      <td class="r">${fmt(d.shares,0)}</td>
      <td class="r green">${fmt(total)}</td>
      <td class="muted" style="font-size:.72rem">${d.notes||'‚Äî'}</td>
      <td><button class="btn btn-warn" onclick="editDiv('${d.id}')">Edit</button> <button class="btn btn-danger" onclick="deleteDiv('${d.id}')">‚úï</button></td>`;
    tbody.appendChild(tr);
    // Mobile card
    const card=document.createElement('div');
    card.className='m-card';
    card.innerHTML=`
      <div class="m-card-header">
        <div>
          <span class="m-card-ticker">${d.ticker}</span>
          <div style="font-family:var(--mono);font-size:.65rem;color:var(--muted);margin-top:.2rem">${d.date||'‚Äî'}</div>
        </div>
        <div class="m-card-actions">
          <button class="btn btn-warn" onclick="editDiv('${d.id}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteDiv('${d.id}')">‚úï</button>
        </div>
      </div>
      <div class="m-card-grid">
        <div class="m-card-field"><div class="m-card-label">Per Share</div><div class="m-card-value" style="color:var(--accent2)">${fmt(d.perShare)} PKR</div></div>
        <div class="m-card-field"><div class="m-card-label">Shares</div><div class="m-card-value">${fmt(d.shares,0)}</div></div>
        <div class="m-card-field"><div class="m-card-label">Total Received</div><div class="m-card-value green">${fmt(total)} PKR</div></div>
        ${d.notes?`<div class="m-card-field"><div class="m-card-label">Notes</div><div class="m-card-value muted" style="font-size:.72rem">${d.notes}</div></div>`:''}
      </div>`;
    cards.appendChild(card);
  });
}

// ===================== STOCK MODALS =====================
function openAddStock() {
  editingId=null;
  document.getElementById('modal-stock-title').innerHTML='Add <span>Stock</span>';
  ['f-ticker','f-shares','f-avgbuy','f-current','f-notes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-ticker').disabled=false;
  document.getElementById('modal-stock').classList.add('open');
}
function openEditStock(id) {
  editingId=id;
  const s=portfolio.find(x=>x.id===id); if(!s)return;
  document.getElementById('modal-stock-title').innerHTML=`Edit <span>${s.ticker}</span>`;
  document.getElementById('f-ticker').value=s.ticker;
  document.getElementById('f-ticker').disabled=true;
  document.getElementById('f-shares').value=s.shares;
  document.getElementById('f-avgbuy').value=s.avgBuy;
  document.getElementById('f-current').value=s.currentPrice||'';
  document.getElementById('f-notes').value=s.notes||'';
  document.getElementById('modal-stock').classList.add('open');
}
async function saveStock() {
  const ticker=document.getElementById('f-ticker').value.trim().toUpperCase();
  const shares=parseFloat(document.getElementById('f-shares').value);
  const avgBuy=parseFloat(document.getElementById('f-avgbuy').value);
  const current=document.getElementById('f-current').value;
  const notes=document.getElementById('f-notes').value.trim();
  if(!ticker||!shares||!avgBuy){ alert('Please fill in ticker, shares, and avg buy price.'); return; }
  if(editingId){
    const idx=portfolio.findIndex(x=>x.id===editingId);
    portfolio[idx]={...portfolio[idx],shares,avgBuy,currentPrice:current||null,notes};
  } else {
    if(portfolio.find(x=>x.ticker===ticker)){ alert('Stock already exists. Edit it instead.'); return; }
    portfolio.push({id:uid(),ticker,shares,avgBuy,currentPrice:current||null,notes});
  }
  closeModal('modal-stock'); render(); await save();
}

// ===================== CONFIRM =====================
function showConfirm(title,msg,cb) {
  document.getElementById('confirm-title').textContent=title;
  document.getElementById('confirm-msg').textContent=msg;
  const btn=document.getElementById('confirm-btn');
  btn.onclick=()=>{ closeModal('modal-confirm'); cb(); };
  document.getElementById('modal-confirm').classList.add('open');
}
function deleteStock(id) {
  const s=portfolio.find(x=>x.id===id);
  showConfirm('Delete Stock',`Remove ${s?.ticker} and all its dividend records?`,async()=>{
    portfolio=portfolio.filter(x=>x.id!==id);
    dividends=dividends.filter(d=>d.ticker!==s?.ticker);
    render(); await save();
  });
}

// ===================== DIVIDEND MODALS =====================
function openAddDiv(ticker) {
  const sel=document.getElementById('fd-ticker');
  sel.innerHTML=portfolio.map(s=>`<option value="${s.ticker}" ${s.ticker===ticker?'selected':''}>${s.ticker}</option>`).join('');
  const stock=portfolio.find(s=>s.ticker===ticker);
  document.getElementById('fd-shares').value=stock?stock.shares:'';
  document.getElementById('fd-pershare').value='';
  document.getElementById('fd-date').value=new Date().toISOString().slice(0,10);
  document.getElementById('fd-notes').value='';
  document.getElementById('modal-div').classList.add('open');
  sel.onchange=()=>{ const s=portfolio.find(x=>x.ticker===sel.value); if(s) document.getElementById('fd-shares').value=s.shares; };
}
async function saveDividend() {
  const ticker=document.getElementById('fd-ticker').value;
  const perShare=parseFloat(document.getElementById('fd-pershare').value);
  const date=document.getElementById('fd-date').value;
  const shares=parseFloat(document.getElementById('fd-shares').value);
  const notes=document.getElementById('fd-notes').value.trim();
  if(!ticker||!perShare||!shares){ alert('Please fill in all required fields.'); return; }
  dividends.push({id:uid(),ticker,perShare,date,shares,notes});
  closeModal('modal-div'); render(); await save();
}
function editDiv(id) {
  const d=dividends.find(x=>x.id===id); if(!d)return;
  document.getElementById('fde-id').value=d.id;
  document.getElementById('fde-ticker').value=d.ticker;
  document.getElementById('fde-pershare').value=d.perShare;
  document.getElementById('fde-date').value=d.date;
  document.getElementById('fde-shares').value=d.shares;
  document.getElementById('fde-notes').value=d.notes||'';
  document.getElementById('modal-div-edit').classList.add('open');
}
async function saveEditDividend() {
  const id=document.getElementById('fde-id').value;
  const idx=dividends.findIndex(x=>x.id===id); if(idx===-1)return;
  dividends[idx]={...dividends[idx],
    perShare:parseFloat(document.getElementById('fde-pershare').value),
    date:document.getElementById('fde-date').value,
    shares:parseFloat(document.getElementById('fde-shares').value),
    notes:document.getElementById('fde-notes').value.trim()
  };
  closeModal('modal-div-edit'); render(); await save();
}
function deleteDiv(id) {
  const d=dividends.find(x=>x.id===id);
  showConfirm('Delete Dividend',`Remove this ${d?.ticker} dividend of PKR ${d?.perShare}/share?`,async()=>{
    dividends=dividends.filter(x=>x.id!==id);
    render(); await save();
  });
}

// ===================== MANUAL PRICES =====================
function openUpdatePrices() {
  document.getElementById('price-fields').innerHTML=portfolio.map(s=>`
    <div class="form-group">
      <label>${s.ticker} ‚Äî Current Price (PKR)</label>
      <input type="number" id="price-${s.id}" value="${s.currentPrice||''}" placeholder="Enter price" step="0.01">
    </div>`).join('');
  document.getElementById('modal-prices').classList.add('open');
}
async function savePrices() {
  portfolio.forEach(s=>{ const v=document.getElementById(`price-${s.id}`)?.value; s.currentPrice=v?parseFloat(v):null; });
  closeModal('modal-prices'); render(); await save();
}

// ===================== UTILS =====================
function closeModal(id){ document.getElementById(id).classList.remove('open'); editingId=null; }
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('open'); }));
function switchTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active'));
  document.getElementById('pane-'+name).classList.add('active');
  el.classList.add('active');
}
function exportData(){
  const blob=new Blob([JSON.stringify({portfolio,dividends,exported:new Date().toISOString()},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='psx-portfolio.json'; a.click();
}

// ===================== INIT =====================
render();
loadFromGitHub();
</script>
</body>
</html>
